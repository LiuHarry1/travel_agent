# ğŸš€ æµå¼è¾“å‡ºä¸­å®æ—¶åˆ¤æ–­ Function Call çš„æ”¹è¿›

## âœ¨ æ”¹è¿›æ¦‚è¿°

å·²å°† **backend_new** é¡¹ç›®ä¸­æµå¼è¾“å‡ºè¿‡ç¨‹ä¸­å®æ—¶åˆ¤æ–­ function call çš„æ–¹æ³•åº”ç”¨åˆ° **backend** é¡¹ç›®ä¸­ã€‚

### æ ¸å¿ƒæ”¹è¿›

**ä¹‹å‰çš„è¡Œä¸ºï¼š**
- å…ˆæµå¼è¾“å‡ºæ‰€æœ‰æ–‡æœ¬å†…å®¹
- ç„¶åæ£€æŸ¥æ˜¯å¦æœ‰ tool calls
- å¦‚æœæœ‰ tool callsï¼Œå†æ‰§è¡Œå·¥å…·

**ç°åœ¨çš„è¡Œä¸ºï¼š**
- åœ¨æµå¼è¾“å‡ºçš„**ç¬¬ä¸€å¸§**å°±èƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·
- å¦‚æœæ£€æµ‹åˆ° tool call â†’ **ç«‹å³åœæ­¢**æ–‡æœ¬è¾“å‡ºï¼Œæ”¶é›†å·¥å…·è°ƒç”¨ä¿¡æ¯
- å¦‚æœåªæœ‰æ–‡æœ¬å†…å®¹ â†’ ç»§ç»­æ­£å¸¸æµå¼è¾“å‡º

## ğŸ“Š æ€§èƒ½æå‡

| åœºæ™¯ | ä¹‹å‰ | ç°åœ¨ |
|------|------|------|
| éœ€è¦è°ƒç”¨å·¥å…·æ—¶ | å…ˆè¾“å‡ºä¸€äº›æ–‡æœ¬ï¼Œç„¶åæ£€æµ‹åˆ°å·¥å…· | ç¬¬ä¸€å¸§å°±æ£€æµ‹åˆ°ï¼Œç«‹å³åœæ­¢æ–‡æœ¬è¾“å‡º |
| æ™®é€šå›å¤ | æ­£å¸¸æµå¼è¾“å‡º | æ­£å¸¸æµå¼è¾“å‡ºï¼ˆæ— å˜åŒ–ï¼‰ |
| å“åº”å»¶è¿Ÿ | è¾ƒé«˜ï¼ˆå…ˆè¾“å‡ºæ–‡æœ¬ï¼‰ | æ›´ä½ï¼ˆç«‹å³æ£€æµ‹ï¼‰ |
| ç”¨æˆ·ä½“éªŒ | å¯èƒ½çœ‹åˆ°éƒ¨åˆ†æ–‡æœ¬ç„¶ååœæ­¢ | ç«‹å³çœ‹åˆ°å·¥å…·è°ƒç”¨æç¤º |

## ğŸ”§ æŠ€æœ¯å®ç°

### ä¿®æ”¹çš„æ–‡ä»¶

1. **`backend/app/service/streaming.py`**
   - ä¼˜åŒ– `stream_with_tool_detection()` æ–¹æ³•
   - æ·»åŠ  `tool_call_detected` å’Œ `tool_call_complete` æ ‡å¿—
   - æ”¹è¿›å®æ—¶æ£€æµ‹é€»è¾‘

### å…³é”®ä»£ç é€»è¾‘

```python
# åœ¨æµå¼å¤„ç†å¾ªç¯ä¸­
if tool_call_updates and not tool_call_detected:
    # Tool call detected for the first time
    tool_call_detected = True
    logger.info(f"ğŸ”§ Tool call detected in chunk {chunk_count}, immediately stopping text streaming")
    # Don't yield any text content from this point on

# Only yield text content if NO tool call has been detected
if content_chunk and not tool_call_detected:
    accumulated_content += content_chunk
    yield (content_chunk, None)
elif content_chunk and tool_call_detected:
    # Skip text content when tool call is detected
    logger.debug(f"Skipping text content chunk (tool call detected)")
```

## ğŸ“ ä½¿ç”¨è¯´æ˜

### ç°æœ‰ä»£ç å…¼å®¹æ€§

**æ— éœ€ä¿®æ”¹ç°æœ‰ä»£ç ï¼** æ”¹è¿›æ˜¯å®Œå…¨å‘åå…¼å®¹çš„ã€‚ç°æœ‰çš„ `ChatService.chat_stream()` æ–¹æ³•å·²ç»ä½¿ç”¨ `stream_with_tool_detection()`ï¼Œä¼šè‡ªåŠ¨å—ç›Šäºè¿™äº›æ”¹è¿›ã€‚

### å·¥ä½œæµç¨‹

1. **ç”¨æˆ·å‘é€æ¶ˆæ¯** â†’ `ChatService.chat_stream()`
2. **è°ƒç”¨æµå¼æ£€æµ‹** â†’ `StreamingService.stream_with_tool_detection()`
3. **å®æ—¶åˆ¤æ–­**ï¼š
   - å¦‚æœæ˜¯ tool call â†’ ç«‹å³åœæ­¢æ–‡æœ¬æµï¼Œæ”¶é›†å·¥å…·ä¿¡æ¯ï¼Œæ‰§è¡Œå·¥å…·
   - å¦‚æœæ˜¯æ™®é€šæ–‡æœ¬ â†’ ç»§ç»­æµå¼è¾“å‡º
4. **å·¥å…·æ‰§è¡Œå** â†’ ç»§ç»­å¯¹è¯ï¼ˆå¤šè½®å¾ªç¯ï¼‰

### æ—¥å¿—è¾“å‡º

æ”¹è¿›åçš„æ—¥å¿—ä¼šæ˜¾ç¤ºï¼š
```
[PERF] First chunk received after 0.234s (TTFB)
ğŸ”§ Tool call detected in chunk 2, immediately stopping text streaming
âœ… Detected 1 complete tool calls, stopping stream
```

## ğŸ§ª æµ‹è¯•å»ºè®®

### æµ‹è¯•ç”¨ä¾‹

1. **æ™®é€šå¯¹è¯ï¼ˆä¸ä½¿ç”¨å·¥å…·ï¼‰**
   - è¾“å…¥: "ä½ å¥½"
   - é¢„æœŸ: æ­£å¸¸æµå¼è¾“å‡ºå›å¤

2. **éœ€è¦è°ƒç”¨å·¥å…·**
   - è¾“å…¥: "æŸ¥ä¸€ä¸‹ä¸Šæµ·çš„å¤©æ°”"
   - é¢„æœŸ: ç«‹å³æ£€æµ‹åˆ° tool callï¼Œåœæ­¢æ–‡æœ¬è¾“å‡ºï¼Œæ‰§è¡Œå·¥å…·

3. **å¤šè½®å·¥å…·è°ƒç”¨**
   - è¾“å…¥: "å…ˆæŸ¥å¤©æ°”ï¼Œç„¶åè®¡ç®— 1+1"
   - é¢„æœŸ: ç¬¬ä¸€è½®è°ƒç”¨å¤©æ°”å·¥å…·ï¼Œç¬¬äºŒè½®è°ƒç”¨è®¡ç®—å™¨å·¥å…·

### éªŒè¯æ–¹æ³•

1. æŸ¥çœ‹æ—¥å¿—ä¸­çš„ `tool_call_detected` æ ‡å¿—
2. æ£€æŸ¥å‰ç«¯æ˜¯å¦æ­£ç¡®æ”¶åˆ° `tool_call_start` äº‹ä»¶
3. ç¡®è®¤æ²¡æœ‰å¤šä½™çš„æ–‡æœ¬å†…å®¹åœ¨å·¥å…·è°ƒç”¨ä¹‹å‰è¾“å‡º

## ğŸ” è°ƒè¯•æŠ€å·§

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œå¯ä»¥ï¼š

1. **æŸ¥çœ‹æ—¥å¿—çº§åˆ«**
   ```python
   # è®¾ç½®æ—¥å¿—çº§åˆ«ä¸º DEBUG
   logging.getLogger("app.service.streaming").setLevel(logging.DEBUG)
   ```

2. **æ£€æŸ¥å·¥å…·å®šä¹‰**
   - ç¡®ä¿å·¥å…·å·²æ­£ç¡®æ³¨å†Œåˆ° MCP Manager
   - æ£€æŸ¥å·¥å…·çš„ schema æ ¼å¼æ˜¯å¦æ­£ç¡®

3. **éªŒè¯æµå¼å“åº”æ ¼å¼**
   - æ£€æŸ¥ chunk æ•°æ®ç»“æ„
   - ç¡®è®¤ `tool_calls` å­—æ®µæ˜¯å¦æ­£ç¡®è§£æ

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `backend/app/service/streaming.py` - æ ¸å¿ƒæµå¼å¤„ç†é€»è¾‘
- `backend/app/service/chat.py` - èŠå¤©æœåŠ¡ï¼ˆä½¿ç”¨æµå¼å¤„ç†ï¼‰
- `backend/app/service/tool_detection.py` - å·¥å…·æ£€æµ‹æœåŠ¡
- `backend/app/service/tool_execution.py` - å·¥å…·æ‰§è¡ŒæœåŠ¡

## ğŸ¯ æœªæ¥ä¼˜åŒ–æ–¹å‘

1. **æ›´æ—©çš„æ£€æµ‹**: æ¢ç´¢åœ¨æ¨¡å‹å†³å®šè°ƒç”¨å·¥å…·æ—¶æ›´æ—©çš„æ£€æµ‹æ–¹æ³•
2. **æ‰¹é‡å·¥å…·è°ƒç”¨**: ä¼˜åŒ–å¤šä¸ªå·¥å…·åŒæ—¶è°ƒç”¨çš„æƒ…å†µ
3. **é”™è¯¯å¤„ç†**: æ”¹è¿›å·¥å…·è°ƒç”¨å¤±è´¥æ—¶çš„å¤„ç†é€»è¾‘
4. **æ€§èƒ½ç›‘æ§**: æ·»åŠ æ›´è¯¦ç»†çš„æ€§èƒ½æŒ‡æ ‡æ”¶é›†

## ğŸ“– å‚è€ƒ

- `backend_new/README_STREAMING_AGENT.md` - åŸå§‹å‚è€ƒå®ç°
- `backend_new/agent.py` - ç®€åŒ–ç‰ˆ Agent å®ç°ç¤ºä¾‹
